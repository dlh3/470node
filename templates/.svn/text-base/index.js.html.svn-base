<script type="text/javascript" charset="utf-8">
// Source: http://stackoverflow.com/questions/333664/simple-long-polling-example-code
var webID = 0;

function waitForMsg()
{
    /* This requests the url "msgsrv.php"
    When it complete (or errors)*/
    $.ajax({
        type: "GET",
        url: "webChat.js?id=" + webID,

        async: true, /* If set to non-async, browser shows page as "Loading.."*/
        cache: false,
        timeout: 60000, /* Timeout in ms */

        beforeSend: function(jqxhr){ /* called when request to barge.php completes */
            xhr._onreadystatechange = xhr.onreadystatechange;
            xhr.onreadystatechange = function() {
                xhr._onreadystatechange();
                if (xhr.readyState == 3)
                {
                    $("#indexChatBox .newMsg").removeClass('newMsg').addClass('oldMsg');
                    alert("New msg:" + msg);
                    $("#indexChatBox").append(
                        "<span class='newMsg'>"+ msg +"</span><br /" + ">"
                    );
                }
                if (readyState == 4)
                    waitForMsg(); /* Request next message */
            };
        },
        error: function(XMLHttpRequest, textStatus, errorThrown){
            setTimeout(
                'waitForMsg()', /* Try again after.. */
                "15000"); /* milliseconds (15seconds) */
        },
    });
}

function sendMsg(theForm)
{
    $.get('webSay.js?id=' + webID + '&msg=' + theForm.message.value, function(resp)
    {
        theForm.message.value = '';
    });
}

function webLogin(theForm)
{
    $.get('webLogin.js?nick=' + theForm.nickname.value, function(resp)
    {
        if (resp == 0)
        {
            alert("Invalid username, try something alphanumeric that is not in use");
            return false;
        }
        webID = resp;
        $("#indexChatLoginForm").hide();
        waitForMsg(); /* Start the inital request */
    });
}
</script>
